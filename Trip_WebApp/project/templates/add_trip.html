
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Trip</title>
    <link rel="shortcut icon" type="image/png" href="{% static 'images/touring.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://bootswatch.com/5/flatly/bootstrap.min.css">
   

    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .previous-trip {
            float: right;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}"><b>Take A Trip</b></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarColor01">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'home' %}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'all_trip_table' %}">Trip Details</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-7">
            
                <ul>
                    {% for message in messages %}
                        <li class="{{ message.tags }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            
                <div class="card shadow-lg mx-3 my-3 py-3" style="background-color: #152733; border-color: white; border-radius: 18px; border-width: 3px;">
                    <div class="card-body" style="color: white;">
                        <h3 class="card-title" style="color: white;">Enter Trip Details</h3>
                        <p>Add your trip details here..</p><br>

                        <form id="tripForm" class="needs-validation" novalidate method="post" action="{% url 'add_trip_details' %}">
                            {% csrf_token %}

                            <div class="mb-3 d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="trip_type" id="km" value="km" required>
                                        <label class="form-check-label" for="km">Kilometers</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="trip_type" id="hour" value="hour" required>
                                        <label class="form-check-label" for="hour">Hours</label>
                                    </div>
                                    <div class="invalid-feedback">Trip type is required</div>
                                </div>
                                <a href="{% url 'update_last_trip' %}" class="btn btn-outline-secondary">Get Last Trip</a>
                            </div>

                            <div class="mb-3 row">
                                <div class="col">
                                    <input type="hidden" id="trip_no_hidden" name="trip_no" value="{{ latest_trip_number }}">
                                    <input class="form-control" type="text" id="trip_no_display" placeholder="Trip Number*" value="{{ latest_trip_number }}" readonly>
                                </div>
                                <div class="col">
                                    <input class="form-control" type="date" name="date" aria-required="true" required>
                                    <div class="valid-feedback">Date field is valid!</div>
                                    <div class="invalid-feedback">Date is required</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <input class="form-control" type="text" name="vehicle_number" id="vehicle_number" placeholder="Vehicle Number*" aria-required="true" required>
                                <div class="valid-feedback">Vehicle number is valid!</div>
                                <div class="invalid-feedback">Vehicle number is required</div>
                            </div>

                            <div class="mb-3">
                                <input class="form-control" type="text" name="vehicle_name" placeholder="Vehicle Name*" aria-required="true" required>
                                <div class="valid-feedback">Vehicle name is valid!</div>
                                <div class="invalid-feedback">Vehicle name is required</div>
                            </div>

                            <div class="mb-3">
                                <input class="form-control" type="text" name="driver_name" placeholder="Driver Name*" aria-required="true" required>
                                <div class="valid-feedback">Driver name is valid!</div>
                                <div class="invalid-feedback">Driver name is required</div>
                            </div>

                            <div class="mb-3">
                                <input class="form-control" type="text" name="guest_name" placeholder="Guest Name*" aria-required="true" required>
                                <div class="valid-feedback">Guest name is valid!</div>
                                <div class="invalid-feedback">Guest name is required</div>
                            </div>

                            <div class="mb-3 row">
                                <div class="col">
                                    <input class="form-control" type="text" name="strt_place" placeholder="Starting Place*" required>
                                    <div class="valid-feedback">Starting place is valid!</div>
                                    <div class="invalid-feedback">Starting place is required</div>
                                </div>
                                <div class="col">
                                    <input class="form-control" type="time" name="time" placeholder="Time*" required>
                                    <div class="valid-feedback">Time is valid!</div>
                                    <div class="invalid-feedback">Time is required</div>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <div class="col">
                                    <input class="form-control" type="number" id="fixed_charge" name="fixed_charge" placeholder="Fixed Charge*" aria-required="true" required>
                                    <div class="valid-feedback">Fixed charge is valid!</div>
                                    <div class="invalid-feedback">Fixed charge is required</div>
                                </div>
                                <div class="col">
                                    <input class="form-control" type="number" id="max_km" name="max_km" placeholder="Max Kilometer*" aria-required="true" required>
                                    <div class="valid-feedback">Max kilometer is valid!</div>
                                    <div class="invalid-feedback">Max kilometer is required</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <input class="form-control" type="number" id="extra_charge" name="extra_charge" placeholder="Extra charge per km*" aria-required="true" required>
                                <div class="valid-feedback">Extra charge per km is valid!</div>
                                <div class="invalid-feedback">Extra charge per km is required</div>
                            </div>

                            <div class="mb-3">
                                <input class="form-control" type="number" id="extra_charge_hour" name="extra_charge_hour" placeholder="Extra charge per hour*" aria-required="true" required>
                                <div class="valid-feedback">Extra charge per hour is valid!</div>
                                <div class="invalid-feedback">Extra charge per hour is required</div>
                            </div>
    
                            <div class="mb-3">
                                <input class="form-control" type="text" name="driver_name" placeholder="Driver Name*" aria-required="true">
                            </div>
    
                            <div class="mb-3">
                                <input class="form-control" type="text" name="guest_name" placeholder="Guest Name*" aria-required="true">
                            </div>
    
                            <div id="kilometers-fields">
                                <div class="mb-3 row">
                                    <div class="col">
                                        <input class="form-control" type="number" id="start_km" name="start_km" placeholder="Starting Kilometer*" >
                                    </div>
                                    <div class="col">
                                        <input class="form-control" type="number" id="end_km" name="end_km" placeholder="Ending Kilometer*" >
                                    </div>
                                </div>
                            </div>
    
                            <div id="hours-fields" class="hidden">
                                <div class="mb-3 row">
                                    <div class="col">
                                        <input class="form-control" type="datetime-local" name="start_hour" placeholder="Starting Hour*">
                                    </div>
                                    <div class="col">
                                        <input class="form-control" type="datetime-local" name="end_hour" placeholder="Ending Hour*">
                                    </div>
                                </div>
                            </div>
    
                            <div class="mb-3 row">
                                <div class="col">
                                    <input class="form-control" type="text" name="strt_place" placeholder="Starting Place*" >
                                </div>
                                <div class="col">
                                    <input class="form-control" type="time" name="time" placeholder="Time*">
                                </div>
                            </div>
    
                            <div class="mb-3 row">
                                <div class="col">
                                    <input class="form-control" type="text" name="destination" placeholder="Destination*">
                                </div>
                                <div class="col">
                                    <input class="form-control" type="time" name="time_arrival" placeholder="Time of Arrival*">
                                </div>
                            </div>
    
                            <div class="mb-3">
                                <p>Trip end date*</p>
                                <input class="form-control" type="date" name="arrival_date" placeholder="Arrival date*" >
                            </div>
    
                            <div class="mb-3">
                                <p></p>
                                <input class="form-control" type="number" name="trip_days" placeholder="No of days*" >
                            </div>
    
                            <div class="mb-3">
                                <p>Additional charges*</p>
                                <div id="inputContainer">
                                    <div class="input-group mb-2">
                                        <input class="form-control" type="number" name="toll" value="0" placeholder="Toll*" >
                                    </div>
                                </div>
                                <button class="btn btn-light add-btn mt-2" type="button">Toll +</button>
                            </div>
                            <hr style="height: 3px;">
    
                            <div class="mb-3">
                                <div id="inputContainer1">
                                    <div class="input-group mb-2">
                                        <input class="form-control" type="number" value="0" name="guidefee" placeholder="Guide Fee*" >
                                    </div>
                                </div>
                                <button class="btn btn-light add-btn2 mt-2" type="button">Fee +</button>
                            </div>
    
                            <div class="mb-3">
                                <p>Additional charges</p>
                                <div id="inputContainer2">
                                    <div class="input-group mb-2">
                                        <input class="form-control" type="number" value="0" name="add_charges" placeholder="Additional charges*" >
                                    </div>
                                </div>
                                <button class="btn btn-light add-btn3 mt-2" type="button">Add +</button>
                            </div>
                            <hr style="height: 3px;">
    
                            <div class="mb-3">
                                <h5 class="text-center">Payment details</h5>
                                <input class="form-control" type="number" id="tot_charge" name="tot_charge" placeholder="Total Charge*" >
                            </div>
    
                            <div class="mb-3">
                                <input class="form-control" type="number" id="advance" name="advance" placeholder="Advance*" value="0.00">
                            </div>
    
                            <div class="mb-3">
                                <input class="form-control" type="number" id="balance" name="balance" placeholder="Balance amount*" >
                            </div>
    
                            <div class="mb-3">
                                <button class="btn btn-primary" type="submit">Submit Trip Details</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>


(function () {
            'use strict';
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
        })();




        document.addEventListener('DOMContentLoaded', function () {
    // Existing JavaScript for form validation and handling

    document.getElementById('getLastTripBtn').addEventListener('click', function() {
        fetch('{% url "get_last_trip_details" %}')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    const messageContainer = document.getElementById('message-container');
                    messageContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    // Populate the form with the last trip data
                    document.getElementsByName('trip_no')[0].value = data.trip_no;
                    document.getElementsByName('date')[0].value = data.date;
                    document.getElementsByName('vehicle_name')[0].value = data.vehicle_name;
                    document.getElementsByName('vehicle_number')[0].value = data.vehicle_number;
                    document.getElementsByName('fixed_charge')[0].value = data.fixed_charge;
                    document.getElementsByName('max_km')[0].value = data.max_km;
                    document.getElementsByName('extra_charge')[0].value = data.extra_charge;
                    document.getElementsByName('driver_name')[0].value = data.driver_name;
                    document.getElementsByName('guest_name')[0].value = data.guest_name;
                    document.getElementsByName('start_km')[0].value = data.start_km;
                    document.getElementsByName('end_km')[0].value = data.end_km;
                    document.getElementsByName('strt_place')[0].value = data.strt_place;
                    document.getElementsByName('time')[0].value = data.time;
                    document.getElementsByName('destination')[0].value = data.destination;
                    document.getElementsByName('time_arrival')[0].value = data.time_arrival;
                    document.getElementsByName('arrival_date')[0].value = data.arrival_date;
                    document.getElementsByName('trip_days')[0].value = data.trip_days;
                    document.getElementsByName('toll')[0].value = data.toll;
                    document.getElementsByName('guidefee')[0].value = data.guidefee;
                    document.getElementsByName('add_charges')[0].value = data.add_charges;
                    document.getElementsByName('tot_charge')[0].value = data.tot_charge;
                    document.getElementsByName('advance')[0].value = data.advance;
                    document.getElementsByName('balance')[0].value = data.balance;
                }
            })
            .catch(error => {
                console.error('Error fetching last trip details:', error);
            });
    });
});











document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('tripForm');
            const kmFields = document.getElementById('kilometers-fields');
            const hourFields = document.getElementById('hours-fields');
            const kmRadio = document.getElementById('km');
            const hourRadio = document.getElementById('hour');

            kmRadio.addEventListener('change', function () {
                kmFields.classList.remove('hidden');
                hourFields.classList.add('hidden');
            });

            hourRadio.addEventListener('change', function () {
                hourFields.classList.remove('hidden');
                kmFields.classList.add('hidden');
            });





            // Bootstrap's custom validation style
            (function () {
                'use strict'
                var forms = document.querySelectorAll('.needs-validation')
                Array.prototype.slice.call(forms)
                    .forEach(function (form) {
                        form.addEventListener('submit', function (event) {
                            if (!form.checkValidity()) {
                                event.preventDefault()
                                event.stopPropagation()
                            }
                            form.classList.add('was-validated')
                        }, false)
                    })
            })()
        });




        (function () {
            'use strict';
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
        })();




        // Trip days calculation

        function calculateDays() {
        var startDate = new Date(document.getElementsByName("date")[0].value);
        var endDate = new Date(document.getElementsByName("arrival_date")[0].value);

        var timeDifference = endDate.getTime() - startDate.getTime();

        var daysDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));

        document.getElementsByName("trip_days")[0].value = daysDifference;
    }

    document.getElementsByName("date")[0].addEventListener("change", calculateDays);
    document.getElementsByName("arrival_date")[0].addEventListener("change", calculateDays);

    calculateDays();









document.addEventListener("DOMContentLoaded", function() {

    function addInputField(containerId, inputName, placeholderText) {
        const container = document.getElementById(containerId);
        const newInputGroup = document.createElement("div");
        newInputGroup.classList.add("input-group");
        newInputGroup.innerHTML = `
            <input class="form-control mb-2" type="number" name="${inputName}" placeholder="${placeholderText}" required>
            <button class="btn btn-outline-secondary remove-btn mb-2" type="button">-</button>
        `;
        container.appendChild(newInputGroup);
        newInputGroup.querySelector('input').addEventListener('input', calculateTotalCharge);
    }

    // Function to remove input fields
    function removeInputField(event) {
        const parentInputGroup = event.target.parentElement;
        parentInputGroup.querySelector('input').removeEventListener('input', calculateTotalCharge);
        parentInputGroup.remove();
        calculateTotalCharge();
    }

    // Event listeners for adding input fields
    document.addEventListener("click", function(event) {
        if (event.target.classList.contains("add-btn")) {
            addInputField("inputContainer", "toll", "Toll*");
        }
        if (event.target.classList.contains("add-btn2")) {
            addInputField("inputContainer1", "guidefee", "Guide Fee*");
        }
        if (event.target.classList.contains("add-btn3")) {
            addInputField("inputContainer2", "add_charges", "Additional charges*");
        }
        if (event.target.classList.contains("remove-btn")) {
            removeInputField(event);
        }
    });

    // Dynamic Trip number
    var tripNumber = document.getElementById('trip_no_hidden').value;
    document.getElementById('trip_no_display').value = tripNumber;

    // Show/hide kilometers and hours fields based on selected trip type
    const kmRadioButton = document.getElementById('km');
    const hourRadioButton = document.getElementById('hour');
    const kilometersFields = document.getElementById('kilometers-fields');
    const hoursFields = document.getElementById('hours-fields');

    kmRadioButton.addEventListener('change', function() {
        if (this.checked) {
            kilometersFields.classList.remove('hidden');
            hoursFields.classList.add('hidden');
        }
    });

    hourRadioButton.addEventListener('change', function() {
        if (this.checked) {
            hoursFields.classList.remove('hidden');
            kilometersFields.classList.add('hidden');
        }
    });

    if (kmRadioButton.checked) {
        kilometersFields.classList.remove('hidden');
        hoursFields.classList.add('hidden');
    } else if (hourRadioButton.checked) {
        hoursFields.classList.remove('hidden');
        kilometersFields.classList.add('hidden');
    } else {
        kilometersFields.classList.add('hidden');
        hoursFields.classList.add('hidden');
    }

    function calculateTotalCharge() {
        var fixedCharge = parseFloat(document.getElementById('fixed_charge').value) || 0;
        var maxKm = parseFloat(document.getElementById('max_km').value) || 0;
        var extraCharge = parseFloat(document.getElementById('extra_charge').value) || 0;
        var startKm = parseFloat(document.getElementById('start_km').value) || 0;
        var endKm = parseFloat(document.getElementById('end_km').value) || 0;

        // Calculate total kilometers traveled
        var totalKmTraveled = endKm - startKm;

        // Calculate extra charges if applicable
        var extraCharges = 0;
        if (totalKmTraveled > maxKm) {
            extraCharges = (totalKmTraveled - maxKm) * extraCharge;
        }

        // Calculate total charge
        var totalCharge = fixedCharge + extraCharges;

        // Add toll, guide fee, and additional charges
        document.querySelectorAll('#inputContainer input[name="toll"]').forEach(input => {
            totalCharge += parseFloat(input.value) || 0;
        });
        document.querySelectorAll('#inputContainer1 input[name="guidefee"]').forEach(input => {
            totalCharge += parseFloat(input.value) || 0;
        });
        document.querySelectorAll('#inputContainer2 input[name="add_charges"]').forEach(input => {
            totalCharge += parseFloat(input.value) || 0;
        });

        document.getElementById('tot_charge').value = totalCharge.toFixed(2);
        calculateBalance();
    }

    // Calculate balance
    function calculateBalance() {
        var totalCharge = parseFloat(document.getElementById('tot_charge').value) || 0;
        var advance = parseFloat(document.getElementById('advance').value) || 0;
        var balance = totalCharge - advance;
        document.getElementById('balance').value = balance.toFixed(2);
    }

    // Add event listeners to initial input fields
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateTotalCharge);
    });

    // Initial calculation
    calculateTotalCharge();
});
</script>



</body>
</html>
